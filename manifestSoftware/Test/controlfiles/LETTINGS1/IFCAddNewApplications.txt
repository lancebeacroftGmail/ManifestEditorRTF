WWW.BLAZE-IS.COM
DELIM=$$
TYPE=INTERFACE
FROM=Orchard Housing Database
TIMER=900
DESCRIPTION=
TRIGGER=
TRIGGERFIELDS=
$$
//
// Check file
//


STARTTIME=GetDate()

//UPDATEPROCESSED=SQLCLEARApplicationProcessed("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==","FS-Case-383388821")

//UPDATEPROCESSED=SQLCLEARHouseholderProcessed("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==","FS-Case-59046473","78")

// Check if any applications are ready to create

GETAPP:

SQLNEWAPP=SQLGetApplications2("ManifestDB","ManifestTest","manifest","go1glqQspCgWFZ4+43FRwA==")

// End if there are no more records to process
IFGOTO($$SQLNEWAPP.HEADER.case_id$$,"=","","END:")

// Write to the logfile
LOG1=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Starting App ",$$SQLNEWAPP.HEADER.case_id$$)

LOG2=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Main Per ID",$$SQLNEWAPP.HEADER.main_app_personid$$)

LOG3=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Main Per NINO",$$SQLNEWAPP.HEADER.main_app_NINumber$$)

// Flag this application so it doesn't get posted again 

UPDATEPROCESSED=SQLUPDATEApplicationProcessed("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$)

// Convert any datetime fields to XMLUTC
MAINADDDATE=GETDATE($$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS_START_DATE$$)
MAINAPPDATE=GETDATE($$SQLNEWAPP.HEADER.APP_DATE$$)
MAINDOB=GETDATE($$SQLNEWAPP.HEADER.main_app_dob$$)

EXPCOMMDATE=GETDATE($$SQLNEWAPP.HEADER.EXPECTEDCOMMDATE$$)
OFFERDATE=GETDATE($$SQLNEWAPP.HEADER.OFFERDATE$$)


// Add main applicant and application to Orchard
// Person must be MAIN JOINT or HOUSEHOLD

MAINDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoapMAIN.txt","NEW","http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)



// Skip MAIN
// IFGOTO("","=","","ADDJOINTAPP:")


// LOGGING Write Log Record
LOGFILE1=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Before Add Main",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$)
LOGFILE2=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"SQL Person ID from application",$$SQLNEWAPP.HEADER.main_app_personid$$)


// Logging write $$SQLNEWAPP.HEADER.main_app_personid$$


MAINADD=OISAddApplication("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)



// Check if there was an error

LOGFILE3=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Add Web Service Response",$$MAINADD.RESPONSE$$)
LOGFILE4=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Add Web Service Error",$$MAINADD.ERROR$$)
LOGFILE5=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"PK of record",$$MAINADD.HEADER.PK$$)



// If no Orchard error continue on
// IFGOTO($$MAINADD.ERROR$$,"=","","ADDJOINTAPP:")
//IFGOTO($$MAINADD.ERROR$$,"=","","SETMAINPERSONID:")
IFGOTO($$MAINADD.ERROR$$,"=","","CREATEDOCS:")

//
// MAIN APP ERROR
//

LOGFILE6=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Main App Error Section",$$MAINADD.HEADER.PK$$)


// Send Email

MAINDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoap.txt","NEW","http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

MAINERR=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com","93xXeK4kTifM39vf64MLiw==","alan@manifestsoftware.co.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")

//MAINERR2=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com","93xXeK4kTifM39vf64MLiw==","Paul.Wickert@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
//MAINERR3=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com","93xXeK4kTifM39vf64MLiw==","Kevin.May@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
//MAINERR4=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com","93xXeK4kTifM39vf64MLiw==","Heather.Draper@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")

LOGFILE6=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"End of Main App Error Section",$$MAINADD.HEADER.PK$$)


GOTO("END:")

//
// New routine to get create tenancy documents

CREATEDOCS:

LOGFILE6A=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Start of CREATEDOCS",$$MAINADD.HEADER.PK$$)

CREATEDOCS=SQLCreateTenancyDocs("CustomerExperienceDB","CustomerExperienceViews","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$)

LOGFILE6B=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"End of CREATEDOCS",$$MAINADD.HEADER.PK$$)

//
// New routine to get Person ID and update SQL

SETMAINPERSONID:

LOGFILE7=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Start of SETMAINPERSONID",$$MAINADD.HEADER.PK$$)


OISMAINREC=OISSearchApplicant("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$MAINADD.HEADER.PK$$)

LOGFILE8=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Response from OISSearchApplicant",$$OISMAINREC.RESPONSE$$)

LOGFILE9=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Person ID from OISSearchApplicant",$$OISMAINREC.HEADER.PERSONNO$$)
LOGFILE10=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Update SQL ID",$$SQLNEWAPP.HEADER.case_id$$)


UPDATEMAINPER=SQLUPDATEApplicationMainPersonID("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$,$$OISMAINREC.HEADER.PERSONNO$$)

// Create Person back into CRM
// Check if they already exist by searching on the person number

//CRMLOOKUP=DYNAMICSREADPersonID("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"http://crm2016:5555/AHLive/","contacts","contactid,fullname",$$OISMAINREC.HEADER.PERSONNO$$)
//CRMLOOKUP=DYNAMICSREADPersonID("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"http://crm2016:5555/Live/","contacts","contactid,fullname",$$OISMAINREC.HEADER.PERSONNO$$)
CRMLOOKUP=DYNAMICSREADPersonID("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"https://crm.polestar-cdn.co.uk/Live/","contacts","contactid,fullname",$$OISMAINREC.HEADER.PERSONNO$$)

// Extract the person GUID from the JSON
JSON=JSONGetGUID($$CRMLOOKUP.RESPONSE$$,"OBJECT")

IFGOTO($$JSON.HEADER.ID$$,"<>","[]","SKIPADDCRM:")

//MAINADD=DYNAMICSADDMainApplicant2("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"http://crm2016:5555/AHLive/","contacts","ADD",$$OISMAINREC.HEADER.PERSONNO$$,$$MAINDOB.XMLUTC$$,"1",$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$)
//MAINADD=DYNAMICSADDMainApplicant2("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"http://crm2016:5555/Live/","contacts","ADD",$$OISMAINREC.HEADER.PERSONNO$$,$$MAINDOB.XMLUTC$$,"1",$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$)
MAINADD=DYNAMICSADDMainApplicant2("x","",$$TP.HEADER.CRMWSUser$$,$$TP.HEADER.CRMWSPass$$,"https://crm.polestar-cdn.co.uk/Live/","contacts","ADD",$$OISMAINREC.HEADER.PERSONNO$$,$$MAINDOB.XMLUTC$$,"1",$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$)



LOGFILE10A=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Created Person in CRM",$$OISMAINREC.HEADER.PERSONNO$$)

SKIPADDCRM:

LOGFILE11=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"Completed update of SQL ID",$$SQLNEWAPP.HEADER.case_id$$)
// MAINERR=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com","93xXeK4kTifM39vf64MLiw==","alan@manifestsoftware.co.uk","OPTIVO TEST APPLICATION DEBUG","Debug details","","","C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt")



ADDJOINTAPP:

// Add Joint Application

// Only add if there is a joint applicant

IFGOTO($$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,"=","","ADDHOUSEHOLDAPP:")


// Convert any datetime fields to XMLUTC
// Removed Joint address start date
//JOINTADDDATE=GETDATE($$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS_START_DATE$$)
LOGFILE12=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"PRE JOINTDOB",$$SQLNEWAPP.HEADER.case_id$$)
JOINTDOB=GETDATE($$SQLNEWAPP.HEADER.joint_app_dob$$)
LOGFILE13=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"POST JOINTDOB",$$SQLNEWAPP.HEADER.case_id$$)

// Add joint applicant to Orchard 

// JOINTDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoapJOINT.txt","NEW","http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)



// Skip Joint
//IFGOTO("","=","","ADDHOUSEHOLDAPP:")




//Amended by Alan 1st November to correct Joint Home Tel
//JOINTADD=OISAddApplication("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)
LOGFILE14=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"PRE JOINTADD",$$SQLNEWAPP.HEADER.case_id$$)
JOINTADD=OISAddApplication("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.JOINT_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)
LOGFILE15=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"POST JOINTADD",$$SQLNEWAPP.HEADER.case_id$$)


// If no Orchard error continue on
// IFGOTO($$JOINTADD.ERROR$$,"=","","ADDHOUSEHOLDAPP:")
IFGOTO($$JOINTADD.ERROR$$,"=","","SETJOINTPERSONID:")

//
// JOINT APP ERROR
//

// Send Email
JOINTDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoap.txt","NEW","http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.JOINT_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

JOINTERR=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"support@manifestsoftware.co.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
JOINTERR2=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Paul.Wickert@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
JOINTERR3=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Kevin.May@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
JOINTERR4=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Heather.Draper@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
JOINTERR5=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"matt.toynbee@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION (NEBULA)","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
LOGFILE18=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"JOINT FAILED",$$SQLNEWAPP.HEADER.case_id$$)

GOTO("END:")



//
// New routine to get Person ID and update SQL
//

SETJOINTPERSONID:

LOGFILE16=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"PRE SETJOINTPERSONID",$$SQLNEWAPP.HEADER.case_id$$)



OISJOINTREC=OISSearchApplicant("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y",$$JOINTADD.HEADER.PK$$)

UPDATEJOINTPER=SQLUPDATEApplicationJointPersonID("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$,$$OISJOINTREC.HEADER.PERSONNO$$)

LOGFILE17=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"POST SETJOINTPERSONID",$$SQLNEWAPP.HEADER.case_id$$)







ADDHOUSEHOLDAPP:

// Add each householder

// Needs to also be where UpdatedOrchard is null
SQLHH=SQLGetHouseholder("ManifestDB","ManifestTest","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$)

// Check no more householders
IFGOTO($$SQLHH.HEADER.HH_SURNAME$$,"=","","END:")

// Flag this application so it doesn't get posted again 

UPDATEPROCESSED=SQLUPDATEHouseholderProcessed("LettingsDB","Lettings_Application_DW","manifest","go1glqQspCgWFZ4+43FRwA==",$$SQLNEWAPP.HEADER.case_id$$,$$SQLHH.HEADER.HHID$$)

// Convert any datetime fields to XMLUTC

HHDOB=GETDATE($$SQLHH.HEADER.HH_DOB$$)

// Add householder to Orchard 

HHADD=OISAddApplication("http://devorchardtest.nebula.dev:38200/arcCentreWS/services/EDRMUA_PERSON_APPLService","ManiHMall","manifest01","Y","Y","","","","","","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$HHDOB.XMLUTC$$,"","",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLHH.HEADER.HH_FORENAME$$,$$SQLHH.HEADER.HH_GENDER$$,"",$$SQLNEWAPP.HEADER.householdGroupID$$,"","","","",$$SQLHH.HEADER.HH_NINumber$$,"HOUSEHOLD",$$SQLHH.HEADER.hh_app_personid$$,"",$$SQLHH.HEADER.HH_RELATIONSHIP$$,"","",$$SQLHH.HEADER.HH_SURNAME$$,$$SQLHH.HEADER.HH_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

// If no Orchard error continue on BACK UP TO GET NEXT HOUSEHOLDER
IFGOTO($$HHADD.ERROR$$,"=","","ADDHOUSEHOLDAPP:")

//
// HH ERROR
//

// Send Email
//HHDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoap.txt","NEW","","","","","","","","","","","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$HHDOB.XMLUTC$$,"","",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLHH.HEADER.HH_FORENAME$$,$$SQLHH.HEADER.HH_GENDER$$,"",$$SQLNEWAPP.HEADER.householdGroupID$$,"","","","",$$SQLHH.HEADER.HH_NINumber$$,"HOUSEHOLD",$$SQLHH.HEADER.hh_app_personid$$,"",$$SQLHH.HEADER.HH_RELATIONSHIP$$,"","",$$SQLHH.HEADER.HH_SURNAME$$,$$SQLHH.HEADER.HH_TITLE$$)
HHDEBUGFILE=DEBUGCREATEADDXML("C:\ManifestSoftware\TEST\Temp\TempSoap.txt","NEW","","","","","","","","","","","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$HHDOB.XMLUTC$$,"","",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLHH.HEADER.HH_FORENAME$$,$$SQLHH.HEADER.HH_GENDER$$,"",$$SQLNEWAPP.HEADER.householdGroupID$$,"","","","",$$SQLHH.HEADER.HH_NINumber$$,"HOUSEHOLD",$$SQLHH.HEADER.hh_app_personid$$,"",$$SQLHH.HEADER.HH_RELATIONSHIP$$,"","",$$SQLHH.HEADER.HH_SURNAME$$,$$SQLHH.HEADER.HH_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

HHERR=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"support@manifestsoftware.co.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")

HHERR2=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Paul.Wickert@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
//HHERR3=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Kevin.May@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")
//HHERR4=EMAILAppError2("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Heather.Draper@optivo.org.uk","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,"C:\ManifestSoftware\TEST\Temp\TempSoap.txt")

GOTO("ADDHOUSEHOLDAPP:")









END:

//LOGFILE18=WRITEERRORLOG("C:\ManifestSoftware\TEST\LogFiles\LettingsLog.txt","UPDATE",$$STARTTIME.TIMESTAMP$$,"END",$$SQLNEWAPP.HEADER.case_id$$)

STOPIFEMPTY("")

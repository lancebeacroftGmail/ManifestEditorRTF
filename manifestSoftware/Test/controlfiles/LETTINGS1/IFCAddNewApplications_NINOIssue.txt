WWW.BLAZE-IS.COM
DELIM=$$
TYPE=INTERFACE
FROM=Orchard Housing Database
TIMER=900
DESCRIPTION=
TRIGGER=
TRIGGERFIELDS=
$$
//
// Check file
//


STARTTIME=GetDate()

P=ReadThreadParameters("C:\ManifestSoftware\TEST\ControlFiles\THREADPARAMS.xml")

//UPDATEPROCESSED=SQLCLEARApplicationProcessed($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,"FS-Case-59393968")

//UPDATEPROCESSED=SQLCLEARHouseholderProcessed($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,"FS-Case-59046473","78")

// Check if any applications are ready to create

GETAPP:

SQLNEWAPP=SQLGetApplications_NINOIssue($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$)


// End if there are no more records to process
IFGOTO($$SQLNEWAPP.HEADER.case_id$$,"=","","END:")


// Write to the logfile
LOG1=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Starting App ",$$SQLNEWAPP.HEADER.case_id$$)

LOG2=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Main Per ID",$$SQLNEWAPP.HEADER.main_app_personid$$)

LOG3=LogMessage("C:\ManifestSoftware\TEST\Temp\Logfile_IFCAddNewApp.txt","Main Per NINO",$$SQLNEWAPP.HEADER.main_app_NINumber$$)


// Flag this application so it doesn't get posted again 

//UPDATEPROCESSED=SQLUPDATEApplicationProcessed($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,$$SQLNEWAPP.HEADER.case_id$$)

// Convert any datetime fields to XMLUTC
MAINADDDATE=GETDATE($$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS_START_DATE$$)
MAINAPPDATE=GETDATE($$SQLNEWAPP.HEADER.APP_DATE$$)
MAINDOB=GETDATE($$SQLNEWAPP.HEADER.main_app_dob$$)

EXPCOMMDATE=GETDATE($$SQLNEWAPP.HEADER.EXPECTEDCOMMDATE$$)
OFFERDATE=GETDATE($$SQLNEWAPP.HEADER.OFFERDATE$$)


// Add main applicant and application to Orchard
// Person must be MAIN JOINT or HOUSEHOLD

MAINDEBUGFILE=DEBUGCREATEADDXML($$P.HEADER.TempSOAPMain$$,"NEW",$$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)



// Skip MAIN
// IFGOTO("","=","","ADDJOINTAPP:")





MAINADD=OISAddApplication($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN","",$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

//MAINADD=OISAddApplication($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

// Check if there was an error

// If no Orchard error continue on
// IFGOTO($$MAINADD.ERROR$$,"=","","ADDJOINTAPP:")
IFGOTO($$MAINADD.ERROR$$,"=","","SETMAINPERSONID:")

//
// MAIN APP ERROR
//

// Send Email

MAINDEBUGFILE=DEBUGCREATEADDXML($$P.HEADER.TempSOAPLog$$,"NEW",$$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS4$$,$$MAINADDDATE.XMLUTC$$,"",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,$$SQLNEWAPP.HEADER.MAIN_APP_CURRENT_TENURECODE$$,"",$$MAINDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.MAIN_APP_EMAIL$$,$$SQLNEWAPP.HEADER.MAIN_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.MAIN_APP_FORENAME$$,$$SQLNEWAPP.HEADER.main_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.MAIN_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.MAIN_NATIONALITY$$,$$SQLNEWAPP.HEADER.main_app_NINumber$$,"MAIN",$$SQLNEWAPP.HEADER.main_app_personid$$,$$SQLNEWAPP.HEADER.MAIN_APP_POSTCODE$$,"",$$SQLNEWAPP.HEADER.MAIN_RELIGION$$,$$SQLNEWAPP.HEADER.MAIN_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.MAIN_APP_SURNAME$$,$$SQLNEWAPP.HEADER.MAIN_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

MAINERR=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"support@manifestsoftware.co.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,$$P.HEADER.TempSOAPLog$$)

MAINERR2=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Paul.Wickert@optivo.org.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add main applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$MAINADD.ERROR$$,$$P.HEADER.TempSOAPLog$$)

GOTO("END:")



//
// New routine to get Person ID and update SQL

SETMAINPERSONID:

OISMAINREC=OISSearchApplicant($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$MAINADD.HEADER.PK$$)

UPDATEMAINPER=SQLUPDATEApplicationMainPersonID($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,$$SQLNEWAPP.HEADER.case_id$$,$$OISMAINREC.HEADER.PERSONNO$$)





ADDJOINTAPP:

// Add Joint Application

// Only add if there is a joint applicant

IFGOTO($$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,"=","","ADDHOUSEHOLDAPP:")


// Convert any datetime fields to XMLUTC
// Removed Joint address start date
//JOINTADDDATE=GETDATE($$SQLNEWAPP.HEADER.MAIN_APP_ADDRESS_START_DATE$$)

JOINTDOB=GETDATE($$SQLNEWAPP.HEADER.joint_app_dob$$)


// Add joint applicant to Orchard 

// JOINTDEBUGFILE=DEBUGCREATEADDXML($$P.HEADER.TempSOAPJoint$$,"NEW",$$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)



// Skip Joint
//IFGOTO("","=","","ADDHOUSEHOLDAPP:")




//Amended by Alan 1st November to correct Joint Home Tel
//JOINTADD=OISAddApplication($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.MAIN_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

JOINTADD=OISAddApplication($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.JOINT_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)


// If no Orchard error continue on
// IFGOTO($$JOINTADD.ERROR$$,"=","","ADDHOUSEHOLDAPP:")
IFGOTO($$JOINTADD.ERROR$$,"=","","SETJOINTPERSONID:")

//
// JOINT APP ERROR
//

// Send Email
JOINTDEBUGFILE=DEBUGCREATEADDXML($$P.HEADER.TempSOAPLog$$,"NEW",$$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS1$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS2$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS3$$,$$SQLNEWAPP.HEADER.JOINT_APP_ADDRESS4$$,"","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$JOINTDOB.XMLUTC$$,$$SQLNEWAPP.HEADER.JOINT_APP_EMAIL$$,$$SQLNEWAPP.HEADER.JOINT_ETHNICITY$$,$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLNEWAPP.HEADER.JOINT_APP_FORENAME$$,$$SQLNEWAPP.HEADER.joint_app_gender$$,$$SQLNEWAPP.HEADER.JOINT_HOMETEL$$,$$SQLNEWAPP.HEADER.householdGroupID$$,"",$$SQLNEWAPP.HEADER.JOINT_MOBILETEL$$,"",$$SQLNEWAPP.HEADER.JOINT_NATIONALITY$$,$$SQLNEWAPP.HEADER.joint_app_NINumber$$,"JOINT",$$SQLNEWAPP.HEADER.joint_app_personid$$,$$SQLNEWAPP.HEADER.JOINT_APP_POSTCODE$$,$$SQLNEWAPP.HEADER.JOINT_RELATIONSHIP$$,$$SQLNEWAPP.HEADER.JOINT_RELIGION$$,$$SQLNEWAPP.HEADER.JOINT_SEX_ORIENTATION$$,$$SQLNEWAPP.HEADER.JOINT_APP_SURNAME$$,$$SQLNEWAPP.HEADER.JOINT_APP_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

JOINTERR=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"support@manifestsoftware.co.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,$$P.HEADER.TempSOAPLog$$)

JOINTERR2=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Paul.Wickert@optivo.org.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add joint applicant to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$JOINTADD.ERROR$$,$$P.HEADER.TempSOAPLog$$)

GOTO("END:")



//
// New routine to get Person ID and update SQL
//

SETJOINTPERSONID:

OISJOINTREC=OISSearchApplicant($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y",$$JOINTADD.HEADER.PK$$)

UPDATEJOINTPER=SQLUPDATEApplicationJointPersonID($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,$$SQLNEWAPP.HEADER.case_id$$,$$OISJOINTREC.HEADER.PERSONNO$$)







ADDHOUSEHOLDAPP:

// Add each householder

// Needs to also be where UpdatedOrchard is null
SQLHH=SQLGetHouseholder($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,$$SQLNEWAPP.HEADER.case_id$$)

// Check no more householders
IFGOTO($$SQLHH.HEADER.HH_SURNAME$$,"=","","END:")

// Flag this application so it doesn't get posted again 

UPDATEPROCESSED=SQLUPDATEHouseholderProcessed($$P.HEADER.LettingsSQLInstance$$,$$P.HEADER.LettingsSQLDB$$,$$P.HEADER.SQLUser$$,$$P.HEADER.SQLPassword$$,$$SQLNEWAPP.HEADER.case_id$$,$$SQLHH.HEADER.HHID$$)

// Convert any datetime fields to XMLUTC

HHDOB=GETDATE($$SQLHH.HEADER.HH_DOB$$)

// Add householder to Orchard 

HHADD=OISAddApplication($$P.HEADER.OISWSPersonApplicationURL$$,$$P.HEADER.OISWSUser$$,"manifest01","Y","Y","","","","","","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$HHDOB.XMLUTC$$,"","",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLHH.HEADER.HH_FORENAME$$,$$SQLHH.HEADER.HH_GENDER$$,"",$$SQLNEWAPP.HEADER.householdGroupID$$,"","","","",$$SQLHH.HEADER.HH_NINumber$$,"HOUSEHOLD",$$SQLHH.HEADER.hh_app_personid$$,"",$$SQLHH.HEADER.HH_RELATIONSHIP$$,"","",$$SQLHH.HEADER.HH_SURNAME$$,$$SQLHH.HEADER.HH_TITLE$$,$$EXPCOMMDATE.XMLUTC$$,$$OFFERDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.OFFERLETTERID$$,$$SQLNEWAPP.HEADER.OFFERREASONID$$,$$SQLNEWAPP.HEADER.OFFERTENURETYPE$$,$$SQLNEWAPP.HEADER.OFFERTYPE$$,$$SQLNEWAPP.HEADER.PRSEQNO$$)

// If no Orchard error continue on BACK UP TO GET NEXT HOUSEHOLDER
IFGOTO($$HHADD.ERROR$$,"=","","ADDHOUSEHOLDAPP:")

//
// HH ERROR
//

// Send Email
HHDEBUGFILE=DEBUGCREATEADDXML($$P.HEADER.TempSOAPLog$$,"NEW","","","","","","","","","","","",$$MAINAPPDATE.XMLUTC$$,$$SQLNEWAPP.HEADER.APPLICATION_REASON_CODE$$,$$SQLNEWAPP.HEADER.APPLICATION_TYPE_CODE$$,"","",$$HHDOB.XMLUTC$$,"","",$$SQLNEWAPP.HEADER.EXTERNAL_APP_REF$$,$$SQLHH.HEADER.HH_FORENAME$$,$$SQLHH.HEADER.HH_GENDER$$,"",$$SQLNEWAPP.HEADER.householdGroupID$$,"","","","",$$SQLHH.HEADER.HH_NINumber$$,"HOUSEHOLD",$$SQLHH.HEADER.hh_app_personid$$,"",$$SQLHH.HEADER.HH_RELATIONSHIP$$,"","",$$SQLHH.HEADER.HH_SURNAME$$,$$SQLHH.HEADER.HH_TITLE$$)

HHERR=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"support@manifestsoftware.co.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,$$P.HEADER.TempSOAPLog$$)

HHERR2=EMAILAppError("https://outlook.office365.com/EWS/Exchange.asmx","CloudServices@Blaze-IS.com",$$P.HEADER.MSSOAuthAppID$$,$$P.HEADER.MSSOAuthClientSecret$$,$$P.HEADER.MSSOAuthTenantID$$,"Paul.Wickert@optivo.org.uk","HTML","OPTIVO TEST ERROR ADDING NEW APPLICATION","Failed to add householder to EDR",$$SQLNEWAPP.HEADER.case_id$$,$$HHDEBUGFILE.ERROR$$,$$P.HEADER.TempSOAPLog$$)

GOTO("ADDHOUSEHOLDAPP:")










END:

STOPIFEMPTY("")
